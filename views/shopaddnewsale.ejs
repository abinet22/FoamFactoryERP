<html lang="en">
  <head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<!-- Meta, title, CSS, favicons, etc. -->
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">


  
	<!-- Bootstrap -->
	<link href="../../../../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Font Awesome -->
	<link href="../../../../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<!-- NProgress -->
	<link href="../../../../vendors/nprogress/nprogress.css" rel="stylesheet">
	<!-- iCheck -->
	<link href="../../../../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
	<!-- bootstrap-wysiwyg -->
	<link href="../../../../vendors/google-code-prettify/bin/prettify.min.css" rel="stylesheet">
	<!-- Select2 -->
	<link href="../../../../vendors/select2/dist/css/select2.min.css" rel="stylesheet">
	<!-- Switchery -->
	<link href="../../../../vendors/switchery/dist/switchery.min.css" rel="stylesheet">
	<!-- starrr -->
	<link href="../../../../vendors/starrr/dist/starrr.css" rel="stylesheet">
	<!-- bootstrap-daterangepicker -->
	<link href="../../../../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">

	<!-- Custom Theme Style -->
	<link href="../../../../build/css/custom.min.css" rel="stylesheet">
	<link href="https://cdn.datatables.net/v/dt/dt-1.13.6/datatables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/v/dt/dt-1.13.6/datatables.min.js"></script>

    <!-- Include Buttons extension CSS and JavaScript -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>

</head>

<body class="nav-md">
	<div class="container body">
		<div class="main_container">
            <% if(user.user_roll == "admin"){%>
                <%- include ('./partials/sidebar') %>
             <% }else if(user.user_roll == "Sales_Manager"){%>
              <%- include ('./partials/sidebarsalesmanager') %>
              <% }else if(user.user_roll =="Inventory_Manager"){%>
                <%- include ('./partials/sidebarinventorymgr') %>
                <% }else if( user.user_roll ==="Production_Manager" ){%>
                  <%- include ('./partials/sidebarproductionmgr') %>
                  <% }%>
            <!-- top navigation -->
            <%- include ('./partials/header') %>
			<!-- /top navigation -->

			<!-- page content -->
			<div class="right_col" role="main">
                
				<div class="">
					<div class="container-fluid">
                        <div class="page-header min-height-100 border-radius-xl mt-4" style="background-image: url('../../../../assets/img/curved-images/sds.jpg'); background-position-y: 50%;">
                          <span class="mask  opacity-6"></span>
                          <div >
                            <nav aria-label="breadcrumb">
                              <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="#">Home</a></li>
                                
                                <li class="breadcrumb-item active" aria-current="page">Add New Sales </li>
                              </ol>
                            </nav>
                          </div>
                        </div>
                      
                      </div>
					<div class="clearfix"></div>
					<div class="row">
                        <%- include ('./partials/messages')%>
						<div class="col-md-12 col-sm-12 ">
							<div class="x_panel">
								<div class="x_title">
									<h2>Add New Sales</h2>
									
									<div class="clearfix"></div>
								</div>
								
								<div class="x_content">
									
									<br />
									<% var pricelist2 = pricelist %>
									<ul class="nav nav-tabs justify-content-end bar_tabs" id="myTab" role="tablist">
										<li class="nav-item">
										  <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home1" role="tab" aria-controls="home" aria-selected="true">Add New Sales</a>
										</li>
										
										
                                          <li class="nav-item">
											<a class="nav-link" id="contact3-tab" data-toggle="tab" href="#contact3" role="tab" aria-controls="contact3" aria-selected="false"><i class="fa fa-list"></i>Today Sales List</a>
										  </li>
									  </ul>
									  <div class="tab-content" id="myTabContent">
										<div class="tab-pane fade show active" id="home1" role="tabpanel" aria-labelledby="home-tab">
										  <div class="row">
											<form id="demo-form2" data-parsley-validate class="form-horizontal form-label-left" action="/productionmanager/addnewsales" method="post">

												
											
											<div class="col-md-12">
												<div class="card-header">
													<label>Product Info</label>
												</div>
											   <div class="card-body">
												<div class="row">
													<div class="col-md-4">
													
														<div class="item form-group">
															<label class="col-form-label col-md-4 label-align" for="full-name">Product Name/Size <span class="required">*</span>
															</label>
															<div class="col-md-8 ">
																<select id="productid" name="productid"  required="required" class="form-control ">
																	<option value="0">Select product name</option>
																	<% productlist.forEach(function(row){%>
																		<option value="<%= row.productid %>"><%= row.productname %></option>
																	<%})%>
																	</select>
															</div>
														</div>
														<div class="item form-group">
															<label class="col-form-label col-md-4 label-align" for="full-name">Brand Name <span class="required">*</span>
															</label>
															<div class="col-md-8 ">
																<select id="brandid" name="brandid"  required="required" class="form-control ">
																	<option value="0">Select brand name</option>
																	<% brandlist.forEach(function(row){%>
																		<option value="<%= row.brandid %>"><%= row.brandname %></option>
																	<%})%>
																	</select>
															</div>
														</div>
														
														<div class="item form-group">
															<label class="col-form-label col-md-4 label-align">Price <span class="required">*</span></label>
															<div class="col-md-8">
															<input type="text" class="form-control" name="price" id="price" autocomplete="off" onkeypress="return onlyNumberKey(event)">
															<span class="fa fa-dollar form-control-feedback right"aria-hidden="true"></span>
															</div>
															</div>
														<div class="item form-group">
															<label class="col-form-label col-md-4 label-align">Quantity <span class="required">*</span></label>
															<div class="col-md-8">
															<input type="text" class="form-control" name="amount" id="amount" autocomplete="off" onkeypress="return onlyNumberKey(event)">
															<span class="fa fa-plus form-control-feedback right" style="color: #8a2c2a;" id="addamount" aria-hidden="true"></span>
															</div>
															</div>
													</div>
														<div class="col-md-8">
															<div class="card-body">
																<div class="" id="combinationlist">
																<i class="fa fa-shopping-cart fa-3x"></i>	<label><code>Sale Cart Product List Will Be Here!</code></label><br>
																	<!-- <ul class="col-md-6 col-sm-6" id="list">
				
																	</ul> -->
																	<table class="table">
																		<thead>
																			<th>Product Name(Size)</th>
																			<th>Brand Name</th>
																			<th>Unit Price</th>
																			<th>Quantity </th>
																			<th>Total</th>
																			<th>Action</th>
																		</thead>
																		<tbody id="tablerow">
																			
																			
																		</tbody>
																		<tfoot>
																			<tr id="totallast" style="display: none;">
																			  <td colspan="4">Total Sales</td>
																			  <td id="totalAmount">0</td>
																			  <td></td>
																			</tr>
																		  </tfoot>
																	</table>
																</div>
															</div>
														</div>
												</div>
											   </div>
												
													
														
												
											</div>
											<div class="col-md-5">
												<div class="card">
													<div class="card-header">
														<label>Customer & Sales Person Info</label>
													</div>
													<div class="">
														<div class="item form-group">
															<label class="col-form-label col-md-4 col-sm-4 label-align" for="full-name">Customer Name <span class="required">*</span>
															</label>
															<div class="col-md-6 col-sm-6 ">
																<input type="text" name="customername" class="form-control">
															</div>
														</div>
														<div class="item form-group">
															<label class="col-form-label col-md-4 col-sm-4 label-align" for="full-name">Customer Phone <span class="required">*</span>
															</label>
															<div class="col-md-6 col-sm-6 ">
																<input type="text" name="customerphone" class="form-control">
															</div>
														</div>
														<div class="item form-group">
															<label class="col-form-label col-md-4 col-sm-4 label-align" for="full-name">Sales Person <span class="required">*</span>
															</label>
															<div class="col-md-6 col-sm-6 ">
																
																<select id="salesperson" name="salesperson"  required="required" class="form-control ">
																	<option value="0">Select sales person </option>
																	<% employeelist.forEach(function(row){%>
																		<option value="<%= row.cusid %>"><%= row.fullname %></option>
																	<%})%>
																	</select>
															</div>
														</div>
													</div>
												</div>
											</div>
											<div class="col-md-7">
												<div class="card">
													<div class="card-header">
														<label>Transaction Info</label>
													</div>
													<div class="card-body">
														<div class="item form-group">
															<label class="col-form-label col-md-4 col-sm-4 label-align" for="full-name">Transaction Type <span class="required">*</span>
															</label>
															<div class="col-md-6 col-sm-6 ">
																<select id="transactiontype" name="transactiontype"  required="required" class="form-control ">
																	<option value="0">Select transaction type </option>
																	<option value="Cash">Cash </option>
																	<option value="Credit">Credit</option>
																	<option value="Bank_Transfer">Bank Transfer</option>
																	</select>
															</div>
														</div>
														<div id="account">
															<div class="item form-group">
																<label class="col-form-label col-md-4 col-sm-4 label-align" for="full-name">Bank Account <span class="required">*</span>
																</label>
																<div class="col-md-6 col-sm-6 ">
																	<select id="bankaccount" name="bankaccount"  required="required" class="form-control ">
																		<option value="0">Select bank account </option>
																		<% bankaccount.forEach(function(row){%>
																			<option value="<%= row.baid %>"><%= row.bankname %>/<%= row.accountno %></option>
																		<%})%>
																		</select>
																</div>
															</div>	
														</div>
														<div class="item form-group">
															<label class="col-form-label col-md-4 col-sm-4 label-align" for="full-name">Paid Amount <span class="required">*</span>
															</label>
															<div class="col-md-6 col-sm-6 ">
																<input type="text" name="paidamount" id="paidamount" class="form-control">
															</div>
														</div>
														<label>Total Sales Amount:-&nbsp;</label><h1 id="totalsaleamount"></h1>
													</div>
												</div>
												<div class="ln_solid"></div>
											<div class="item form-group">
												<div class="col-md-6 col-sm-6 offset-md-3">
													<input type="hidden" name="rowmaterialamountobjarray" id="rowmaterialamountobjarray">
													<button type="submit" class="btn btn-success btn-block">Submit</button>
												</div>
											</div>
											</div>
										
	
										</form>
										  </div>
										  <script>
											function onlyNumberKey(evt) {
												 
												// Only ASCII character in that range allowed
												var ASCIICode = (evt.which) ? evt.which : evt.keyCode
												if (ASCIICode > 31 && (ASCIICode < 48 || ASCIICode > 57))
													return false;
												return true;
											}
										</script>
											<script>
												document.addEventListener("DOMContentLoaded", function () {
													const rowMaterialAmountArray = []; // Initialize an empty array to store JSON objects
												   
													document.getElementById("addamount").addEventListener("click", function () {
														const productId = document.getElementById("productid").value;
														const brandId = document.getElementById("brandid").value;
														const amountInput = document.getElementById("amount");
														const priceinput = document.getElementById("price");
														const amount = parseFloat(amountInput.value); // Parse the input as a float
														const price = parseFloat(priceinput.value); 
														const rowMaterialSelect = document.getElementById("productid");
														const selectedOption = rowMaterialSelect.options[rowMaterialSelect.selectedIndex];
														const productName = selectedOption.text; // Get the text of the selected option
														const brandselect = document.getElementById("brandid");
														const brandOption = brandselect.options[brandselect.selectedIndex];
														const brandName = brandOption.text; // Get the text of the selected option
												
														if (amountInput !=="" && brandId !=="0" && productId !== "0" && price !==0 && price !== null && amount !== null && amount !== 0) {
															var total = parseFloat(amount) * parseFloat(price)
															const rowMaterialAmountObj = {
																brandId: brandId,
																productId: productId,
																productName: productName,
																unitprice:price,
																amount: amount,
																totalsale:total
															};
															rowMaterialAmountArray.push(rowMaterialAmountObj);
												
															// Append the JSON object to the list
															//$("#list").append("<li><input type='checkbox'  class='form-check-input' checked >" + rowMaterialName + " " + amount + "<span class='removeItem' data-rowMaterialId='${rowMaterialId}'>Remove</span></li>");
														//	const listItem = document.createElement("li");
															const tableRow = document.createElement("tr");
            // listItem.innerHTML = `<input type='checkbox' class='form-check-input' checked > ${productName}${brandName} ${amount} <span class='removeItem badge bg-red' data-rowMaterialId='${productId}'>Remove</span>`;
            // document.getElementById("list").appendChild(listItem);
			tableRow.innerHTML = `<td> ${productName} </td><td>${brandName} </td><td>${price} </td><td>${amount}</td><td class='amount'>${total}</td> <td><span class='removeItem badge bg-red' data-rowMaterialId='${productId}'>Remove</span></td>`;
            document.getElementById("tablerow").appendChild(tableRow);

															// Update the hidden input field with the array of objects
															//document.getElementById("rowmaterialamountobjarray").value = JSON.stringify(rowMaterialAmountArray);
															updateRowMaterialAmountArray();
															updateTotalAmount();

															// Clear the input fields
															
															document.getElementById("productid").value = "0";
															document.getElementById("brandid").value = "0";
															document.getElementById("price").value = 0;
															document.getElementById("amount").value = 0;
														}
													});
													updateTotalAmount();
	document.getElementById("tablerow").addEventListener("click", function (event) {
    if (event.target.classList.contains("removeItem")) {
        const rowMaterialIdToRemove = event.target.getAttribute("data-rowMaterialId");

        // Find the parent table row (tr) of the clicked element
        const tableRow = event.target.closest("tr");

        // Remove the entire table row
        if (tableRow) {
            tableRow.remove();

            // Remove the item from the array
            const indexToRemove = rowMaterialAmountArray.findIndex(item => 
                item.productId === rowMaterialIdToRemove
            );

            if (indexToRemove !== -1) {
                rowMaterialAmountArray.splice(indexToRemove, 1);

                // Update the hidden input field with the updated array of objects
                updateRowMaterialAmountArray();
				updateTotalAmount();
            }
        }
    }
});
function updateTotalAmount() {
    // Calculate the sum of all rows' total amounts
    const totalAmountElement = document.getElementById("totalAmount");
    let totalAmount = 0;

    // Iterate through the rows and sum the amounts
	const tableRows = document.querySelectorAll("#tablerow tr");
    tableRows.forEach(row => {
        const amountCell = row.querySelector(".amount"); // Assuming you have a class "amount" for the amount cells
        if (amountCell) {
            totalAmount += parseFloat(amountCell.textContent) || 0;
			
			document.getElementById('totalsaleamount').innerHTML ="";
			document.getElementById('totalsaleamount').innerHTML = totalAmount +"Birr";
        }
    });

    // Update the total amount cell
    totalAmountElement.textContent = totalAmount.toFixed(2);
	const totallast = document.getElementById("totallast");
    totallast.style.display = tableRows.length > 0 ? "table-row" : "none";
}
    // Function to update the hidden input field with the array of objects
    function updateRowMaterialAmountArray() {
        document.getElementById("rowmaterialamountobjarray").value = JSON.stringify(rowMaterialAmountArray);
    }
												
												
												});
												</script>
												<script>
													document.addEventListener("DOMContentLoaded", function () {
														// Get references to the select elements and price input
														const productSelect = document.getElementById("productid");
														const brandSelect = document.getElementById("brandid");
														const priceInput = document.getElementById("price");
													
														// Your pricelist data (replace this with your actual data)
														//const pricelist = <%= JSON.stringify(pricelist) %>;
														const pricelistJSON = `<%= JSON.stringify(pricelist) %>`;
    
														// Replace escaped quotes with regular quotes
														const cleanedPricelistJSON = pricelistJSON.replace(/&#34;/g, '"');
														
														// Parse the cleaned JSON data into a JavaScript object
														const pricelist = JSON.parse(cleanedPricelistJSON);

														// Event listener for the brand select element
														brandSelect.addEventListener("change", function () {
															const selectedProductid = productSelect.value;
															const selectedBrandid = brandSelect.value;
													
															// Find the matching price in the pricelist
															const matchingPrice = pricelist.find(item => item.productid === selectedProductid && item.brandid === selectedBrandid);
															console.log(pricelist)
															if (matchingPrice) {
																// Update the price input with the matching price
																priceInput.value = matchingPrice.proprice;
															} else {
																// If no matching price is found, you can handle this case here
																priceInput.value = ""; // Set it to an empty value or display an error message
															}
														});
													});
													</script>
													
										</div>
                                    
                                          <div class="tab-pane fade" id="contact3" role="tabpane" aria-labelledby="contact3-tab">
											<table class="table jambo_table bulk_action" id="myTable2">
												<thead>
												  <tr class="headings">
												    <th>#</th>
													<th class="column-title">Product Name </th>
													<th class="column-title">Brand Name </th>
													<th class="column-title">Total Amount </th>
													<th class="column-title">Transaction Type</th>
												
													<th class="column-title">Customer Info</th>
													<th class="column-title">Sales Person Info</th>
													<th class="column-title">Action</th>
												  </tr>
												</thead>
						
												<tbody>
												
											   <% if(todaysaledata.length >0){%>
												<% var i =0 %>
											   <% todaysaledata.forEach(function (row){%>
												<% i++ %> 
												<% var stat = row.status %>
												<% if(stat ==="Deleted"){ %>
													<tr class="even pointer" style="background-color: #8a2c2a; color: #fafafa;">
														<td class=" "><%= i %></td>
														<td><%= row.productname %></td>
														<td class=" "><% var brand =  row.brandid %>
															<% brandlist.forEach(function(row){%>
															 <% if(row.brandid === brand){%>
																<%= row.brandname %>
															 <%}%>
															<%})%>
														
														</td>
													
													
													
														<td class=" "><%= row.totalfinal %></td>
														<td class=" "><% var ware = row.addedtowarehouse %>
														
															   Date: <%= new Date(row.createdAt).toLocaleDateString() %>
														</td>
														<td class=" "><%= row.status %></td>
														<td class=" "><%= row.status %></td>
														<td class=" "><%= row.status %></td>
														<td class=" ">
															<button type="button" class="btn btn-sm btn-outline-danger">Already RollBack</button>
													
														</td>
													
													  </tr>
												<% }else {%>
													<tr class="even pointer">
														<td class=" "><%= i %></td>
														<td><%= row.productname %></td>
														<td class=" "><% var brand =  row.brandid %>
															<% brandlist.forEach(function(row){%>
															 <% if(row.brandid === brand){%>
																<%= row.brandname %>
															 <%}%>
															<%})%>
														
														</td>
													
													
													
														<td class=" "><%= row.totalfinal %></td>
														<td class=" "><% var ware = row.addedtowarehouse %>
														
															   Date:<%= new Date(row.createdAt).toLocaleDateString() %>
														</td>
														<td class=" "><%= row.status %></td>
														<td class=" ">
														<form action="/productionmanager/deleteandupdatefinalproduct/<%= row.fpid %>" method="post">
															<button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
														</form>
	
														</td>
													
													  </tr>
												<%}%>
											
											   <% })}else{%>
												<tr>
													<div class="alert alert-warning alert-dismissible " role="alert">
														<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span>
														</button>
														<strong>Error!</strong> No Foam Final Mattress Production Data Found!
													  </div>
												</tr>
											   <% }%>

											
											  </table>
										  </div>

									  </div>
									
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
			<!-- /page content -->

			<!-- footer content -->
		<%- include ('./partials/footer')%>
			<!-- /footer content -->
		</div>
	</div>

	<!-- jQuery -->
	<script src="../../../../vendors/jquery/dist/jquery.min.js"></script>
	<!-- Bootstrap -->
	<script src="../../../../vendors/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
	<!-- FastClick -->
	<script src="../../../../vendors/fastclick/lib/fastclick.js"></script>
	<!-- NProgress -->
	<script src="../../../../vendors/nprogress/nprogress.js"></script>
	<!-- bootstrap-progressbar -->
	<script src="../../../../vendors/bootstrap-progressbar/bootstrap-progressbar.min.js"></script>
	<!-- iCheck -->
	<script src="../../../../vendors/iCheck/icheck.min.js"></script>
	<!-- bootstrap-daterangepicker -->
	<script src="../../../../vendors/moment/min/moment.min.js"></script>
	<script src="../../../../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
	<!-- bootstrap-wysiwyg -->
	<script src="../../../../vendors/bootstrap-wysiwyg/js/bootstrap-wysiwyg.min.js"></script>
	<script src="../../../../vendors/jquery.hotkeys/jquery.hotkeys.js"></script>
	<script src="../../../../vendors/google-code-prettify/src/prettify.js"></script>
	<!-- jQuery Tags Input -->
	<script src="../../../../vendors/jquery.tagsinput/src/jquery.tagsinput.js"></script>
	<!-- Switchery -->
	<script src="../../../../vendors/switchery/dist/switchery.min.js"></script>
	<!-- Select2 -->
	<script src="../../../../vendors/select2/dist/js/select2.full.min.js"></script>
	<!-- Parsley -->
	<script src="../../../../vendors/parsleyjs/dist/parsley.min.js"></script>
	<!-- Autosize -->
	<script src="../../../../vendors/autosize/dist/autosize.min.js"></script>
	<!-- jQuery autocomplete -->
	<script src="../../../../vendors/devbridge-autocomplete/dist/jquery.autocomplete.min.js"></script>
	<!-- starrr -->
	<script src="../../../../vendors/starrr/dist/starrr.js"></script>
	<!-- Custom Theme Scripts -->
	<script src="../../../../build/js/custom.min.js"></script>
	<script>
		$(document).ready(function() {
			
			
			$('#myTable').DataTable( {
			
    buttons: [
        'copy', 'excel', 'pdf'
    ]
} );
		});
	</script>
	<link href="https://cdn.datatables.net/v/dt/dt-1.13.6/datatables.min.css" rel="stylesheet">
 
	<script src="https://cdn.datatables.net/v/dt/dt-1.13.6/datatables.min.js"></script>
	
	


</body></html>
